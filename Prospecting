<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prospecting Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green background */
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.1);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #059669; /* Emerald 600 */
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #047857; /* Emerald 700 */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #10b981; /* Emerald 500 */
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #059669; /* Emerald 600 */
        }
        .result-box {
            background-color: #f0fff4; /* Very light green */
            border-left: 4px solid #059669;
        }
        /* Custom table styling */
        .prospects-table th, .prospects-table td {
            white-space: normal; /* Allow text wrapping */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

<div id="app" class="w-full max-w-4xl space-y-6">
    <div class="p-5 text-center bg-emerald-600 text-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-extrabold">Local Business Prospector</h1>
        <p class="mt-1 text-emerald-200">Find and extract leads based on keyword and geographic radius.</p>
        <div id="authStatus" class="mt-2 text-xs font-medium bg-emerald-700 inline-block px-3 py-1 rounded-full">Authenticating...</div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="card space-y-5">
        <h2 class="text-xl font-bold text-emerald-700 border-b pb-2">Search Parameters</h2>

        <!-- Input Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Keyword Input -->
            <div class="md:col-span-1">
                <label for="keywordInput" class="block text-sm font-medium text-gray-700 mb-1">Keywords</label>
                <input type="text" id="keywordInput" placeholder="Cabinet maker, restaurant" 
                       class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500" disabled>
            </div>

            <!-- Location Input -->
            <div class="md:col-span-1">
                <label for="locationInput" class="block text-sm font-medium text-gray-700 mb-1">Target Location</label>
                <input type="text" id="locationInput" placeholder="New York City, NY" 
                       class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500" disabled>
            </div>

            <!-- Radius Selection -->
            <div class="md:col-span-1">
                <label for="radiusSelect" class="block text-sm font-medium text-gray-700 mb-1">Search Radius (km)</label>
                <select id="radiusSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500 bg-white" disabled>
                    <option value="5">5 km</option>
                    <option value="10" selected>10 km</option>
                    <option value="20">20 km</option>
                    <option value="50">50 km</option>
                    <option value="100">100 km</option>
                </select>
            </div>
        </div>
        
        <button onclick="startProspecting()" id="searchBtn" class="w-full py-3 text-white font-semibold rounded-lg btn-primary disabled:opacity-50 flex items-center justify-center" disabled>
            <span id="searchBtnText">Find Leads (Max 30 per page)</span>
        </button>
    </div>
    
    <!-- Prospecting Results Area -->
    <div id="prospectingResult" class="hidden mt-4 p-4 card space-y-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-2 gap-2">
            <strong class="text-xl font-bold text-emerald-800">Found Leads (<span id="totalLeadsCount">0</span> Total)</strong>
            <div class="flex gap-2">
                <button onclick="exportToCsv()" id="exportBtn" class="py-2 px-4 bg-gray-500 text-white text-sm font-semibold rounded-lg hover:bg-gray-600 transition disabled:opacity-50" disabled>
                    Export All (<span id="exportCount">0</span>)
                </button>
            </div>
        </div>

        <div id="pageStatus" class="text-sm font-medium text-emerald-700"></div>
        
        <div id="prospectingOutput" class="overflow-x-auto">
            <table id="prospectsTable" class="prospects-table min-w-full divide-y divide-emerald-200 shadow-md rounded-lg">
                <thead class="bg-emerald-100"></thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <button onclick="loadMoreLeads()" id="loadMoreBtn" class="w-full py-3 text-white font-semibold rounded-lg btn-secondary disabled:opacity-50 flex items-center justify-center" disabled>
            <span id="loadMoreBtnText">Load Next 30 Leads</span>
        </button>
    </div>

    <!-- API Error Display -->
    <div id="apiError" class="mt-4 text-center text-sm text-red-600 p-3 bg-red-100 border border-red-300 rounded-lg hidden"></div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GEMINI API KEY AND CONFIG ---
    const apiKey = ""; 
    const model = "gemini-2.5-flash-preview-09-2025";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
    
    // --- APP STATE FOR PAGINATION ---
    const LEADS_PER_PAGE = 30; // Max number of leads to request per prompt
    let currentLeads = []; // Stores ALL parsed lead data

    // --- FIREBASE AND AUTH SETUP (MANDATORY) ---
    let isAuthReady = false;

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    function enableInputs(enable) {
        document.getElementById('keywordInput').disabled = !enable;
        document.getElementById('locationInput').disabled = !enable;
        document.getElementById('radiusSelect').disabled = !enable;
        document.getElementById('searchBtn').disabled = !enable;
    }

    if (firebaseConfig) {
        setLogLevel('Debug');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 

        onAuthStateChanged(auth, async (user) => {
            const authStatusEl = document.getElementById('authStatus');

            if (user) {
                authStatusEl.textContent = 'Ready';
                authStatusEl.classList.remove('bg-emerald-700');
                authStatusEl.classList.add('bg-green-600');
                isAuthReady = true;
                enableInputs(true);
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth Error:", error);
                    authStatusEl.textContent = 'Auth Failed';
                    authStatusEl.classList.remove('bg-emerald-700');
                    authStatusEl.classList.add('bg-red-600');
                }
            }
        });
    } else {
        console.error("Firebase config not found.");
        document.getElementById('authStatus').textContent = 'Error';
    }
    // --- END FIREBASE SETUP ---

    const apiErrorEl = document.getElementById('apiError');
    const keywordInputEl = document.getElementById('keywordInput');
    const locationInputEl = document.getElementById('locationInput');
    const radiusSelectEl = document.getElementById('radiusSelect');
    const searchBtnEl = document.getElementById('searchBtn');
    const searchBtnTextEl = document.getElementById('searchBtnText');
    const prospectingResultEl = document.getElementById('prospectingResult');
    const loadMoreBtnEl = document.getElementById('loadMoreBtn');
    const loadMoreBtnTextEl = document.getElementById('loadMoreBtnText');
    const exportBtnEl = document.getElementById('exportBtn');
    const totalLeadsCountEl = document.getElementById('totalLeadsCount');
    const exportCountEl = document.getElementById('exportCount');
    const pageStatusEl = document.getElementById('pageStatus');
    const tableHeadEl = document.querySelector('#prospectsTable thead');
    const tableBodyEl = document.querySelector('#prospectsTable tbody');


    // Utility function to handle API retries with exponential backoff
    async function fetchWithRetry(url, options, maxRetries = 5) {
        let lastError = null;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                lastError = error;
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                // console.warn(`API call failed. Retrying in ${(delay / 1000).toFixed(1)}s...`); // Commented out to reduce console noise
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        throw new Error(`API failed after ${maxRetries} attempts: ${lastError.message}`);
    }

    /**
     * Common function to handle API call and results with Google Search grounding.
     * @param {string} userQuery - The query string.
     * @returns {Promise<string>} - The raw Markdown text response.
     */
    async function runGeminiTask(userQuery) {
        // System prompt ensures the model acts as the extractor and outputs a clean table
        const systemPrompt = "You are an expert lead generation data extractor. Use the Google Search tool to find relevant businesses. Your output MUST be a clean Markdown table containing ONLY the columns: | Business Name | Full Address | Phone Number | Operating Hours |. Do not include any introductory or concluding text, only the formatted table.";

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }], 
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        };

        try {
            const response = await fetchWithRetry(apiUrl, options);
            const result = await response.json();
            
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            } else if (result.error?.message) {
                 throw new Error(result.error.message);
            }
            throw new Error("API returned an unexpected response format.");

        } catch (error) {
            console.error("Gemini Task Failed:", error);
            apiErrorEl.textContent = `Error: ${error.message}`;
            apiErrorEl.classList.remove('hidden');
            return null;
        }
    }

    /**
     * Parses the Markdown table output and adds/replaces table rows.
     * @param {string} markdownText - The raw Markdown table text.
     * @param {boolean} isInitialLoad - True if this is the first page load.
     * @returns {number} The number of leads successfully parsed in this batch.
     */
    function renderProspectsTable(markdownText, isInitialLoad) {
        
        // Filter lines that start with '|' and remove any leading/trailing whitespace
        const lines = markdownText.trim().split('\n')
            .map(line => line.trim())
            .filter(line => line.startsWith('|') && line.length > 1);

        if (lines.length < 2) {
            if (isInitialLoad) {
                tableBodyEl.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Could not find any leads or parse the table. Try a different query.</td></tr>`;
            }
            return 0;
        }

        // 1. Extract Header (only needed for the initial load)
        const headerLine = lines[0];
        const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
        
        if (isInitialLoad) {
            // Setup the table header
            const headerHtml = `
                <tr>
                    ${headers.map(h => `<th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider">${h}</th>`).join('')}
                </tr>
            `;
            tableHeadEl.innerHTML = headerHtml;
            // Clear old data
            tableBodyEl.innerHTML = '';
            currentLeads = [];
        }

        // 2. Extract Data Rows (start after the header and separator lines)
        const dataRows = lines.slice(2);
        let batchCount = 0;
        
        dataRows.forEach(rowLine => {
            const columns = rowLine.split('|').map(c => c.trim()).filter(c => c);
            
            // Check if column count matches header count for data integrity
            if (columns.length === headers.length) {
                
                // Store the lead data as an object for CSV export later
                const lead = {};
                for (let i = 0; i < headers.length; i++) {
                    // Use a clean key name for the object
                    lead[headers[i].replace(/\s/g, '_')] = columns[i]; 
                }
                currentLeads.push(lead);
                batchCount++;
                
                // Append the row to the existing table body
                const rowHtml = document.createElement('tr');
                rowHtml.className = "hover:bg-gray-50 transition duration-150";
                rowHtml.innerHTML = columns.map(c => `<td class="px-4 py-3 text-sm text-gray-800 align-top">${c}</td>`).join('');
                tableBodyEl.appendChild(rowHtml);
            }
        });
        
        return batchCount;
    }


    /**
     * Converts the currentLeads array into a CSV format and triggers a download.
     */
    window.exportToCsv = function() {
        if (currentLeads.length === 0) return;

        // Get headers from the first object keys (which are clean, e.g., 'Business_Name')
        const headers = Object.keys(currentLeads[0]);
        // Convert clean keys back to Title Case for CSV header
        const csvHeaders = headers.map(h => h.replace(/_/g, ' ')).join(',');
        
        const csvRows = [];
        csvRows.push(csvHeaders);

        // Iterate over data and format rows
        for (const row of currentLeads) {
            const values = headers.map(header => {
                const value = row[header] || ''; // Handle null/undefined values
                const escaped = ('' + value).replace(/"/g, '""'); // Escape double quotes
                return `"${escaped}"`; // Quote every field
            });
            csvRows.push(values.join(','));
        }

        const csvString = csvRows.join('\n');
        
        // Create Blob and download link
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        const keyword = keywordInputEl.value.trim().replace(/\s/g, '_');
        const location = locationInputEl.value.trim().replace(/\s/g, '_');
        link.download = `leads_${keyword}_${location}_${currentLeads.length}_total.csv`;
        link.href = URL.createObjectURL(blob);
        link.click();
    }


    /**
     * Shared function to fetch leads.
     * @param {boolean} isInitialSearch - True for the 'Find Leads' button, False for 'Load More'.
     */
    async function fetchLeads(isInitialSearch) {
        if (!isAuthReady) return;

        const keyword = keywordInputEl.value.trim();
        const location = locationInputEl.value.trim();
        const radius = radiusSelectEl.value;

        if (!keyword || !location) {
            const msg = "Please enter both a Keyword and a Target City/Location.";
            apiErrorEl.textContent = msg;
            apiErrorEl.classList.remove('hidden');
            return;
        }
        apiErrorEl.classList.add('hidden'); 
        
        if (isInitialSearch) {
            // Reset for a new search
            prospectingResultEl.classList.add('hidden');
            loadMoreBtnEl.disabled = true;
        } 
        
        const leadsFoundSoFar = currentLeads.length;

        // UI Feedback for both buttons
        const buttonToDisable = isInitialSearch ? searchBtnEl : loadMoreBtnEl;
        const buttonTextEl = isInitialSearch ? searchBtnTextEl : loadMoreBtnTextEl;
        
        buttonToDisable.disabled = true;
        loadMoreBtnEl.disabled = true; // Disable Load More while search is running
        exportBtnEl.disabled = true;

        const originalText = buttonTextEl.textContent;
        buttonTextEl.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Searching Leads...';
        
        let query;

        if (isInitialSearch) {
             // For the initial search, ask clearly for the first 30
             query = `Find the first ${LEADS_PER_PAGE} businesses matching the keyword "${keyword}" within a ${radius} km radius of "${location}".`;
             pageStatusEl.textContent = `Fetching the first ${LEADS_PER_PAGE} leads...`;
        } else {
             // For loading more, ask for the next batch, excluding the ones we have already
             query = `Find the next batch of up to ${LEADS_PER_PAGE} businesses matching the keyword "${keyword}" within a ${radius} km radius of "${location}". These results MUST NOT be duplicates of the first ${leadsFoundSoFar} leads already returned.`;
             const startNumber = leadsFoundSoFar + 1;
             pageStatusEl.textContent = `Fetching leads starting from result #${startNumber}...`;
        }

        const text = await runGeminiTask(query);

        let leadsFoundInBatch = 0;
        if (text) {
            // Output Display: Use the new rendering function
            leadsFoundInBatch = renderProspectsTable(text, isInitialSearch);
            prospectingResultEl.classList.remove('hidden');
        }
        
        // UI Reset
        buttonTextEl.textContent = originalText;
        if (isInitialSearch) {
             buttonToDisable.disabled = false; // Only re-enable search button if it was the initial search
        }
        
        // Update counts
        totalLeadsCountEl.textContent = currentLeads.length;
        exportCountEl.textContent = currentLeads.length;
        exportBtnEl.disabled = currentLeads.length === 0;

        // Check if there are potentially more pages
        if (leadsFoundInBatch === LEADS_PER_PAGE) {
            loadMoreBtnEl.disabled = false;
            loadMoreBtnTextEl.textContent = 'Load Next 30 Leads';
            pageStatusEl.textContent = `Successfully added ${leadsFoundInBatch} leads. Total leads: ${currentLeads.length}. Click to load the next page.`;
        } else if (leadsFoundInBatch > 0) {
            loadMoreBtnEl.disabled = true;
            loadMoreBtnTextEl.textContent = 'No More Leads Available';
            pageStatusEl.textContent = `Search finished. Found ${leadsFoundInBatch} leads in this batch. Total leads: ${currentLeads.length}. The end of the search results has been reached for this query.`;
        } else {
             loadMoreBtnEl.disabled = true;
             loadMoreBtnTextEl.textContent = 'No Leads Found';
             pageStatusEl.textContent = `No leads found for this batch. The search has reached its end or the query produced no more unique results.`;
        }
    }

    /**
     * Function to initiate the first page of the prospecting search.
     */
    window.startProspecting = function() {
        // Clear all previous results before starting a new search
        currentLeads = [];
        tableBodyEl.innerHTML = '';
        fetchLeads(true);
    }
    
    /**
     * Function to load the next page of leads.
     */
    window.loadMoreLeads = function() {
        fetchLeads(false);
    }


    // Enable search on Enter key press in input fields
    keywordInputEl.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !searchBtnEl.disabled) {
            startProspecting();
        }
    });
    locationInputEl.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !searchBtnEl.disabled) {
            startProspecting();
        }
    });

    // Set a default value for the location input to make it easy to test
    document.addEventListener('DOMContentLoaded', () => {
        locationInputEl.value = "Vancouver, BC";
        keywordInputEl.value = "Coffee Shops";
    });

</script>

</body>
</html>
